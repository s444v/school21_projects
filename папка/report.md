# Отчёт

## Part 1. Инструмент ipcalc

### 1.1. Сети и маски
- Определяем адрес сети **`ipcalc 192.167.38.54/13`**\
![Вывод команды ipcalc](img/1_1_1_ipcalc.png)
- перевод маски 255.255.255.0 в префиксную и двоичную запись\
![Вывод команды ipcalc](img/1_1_2_ipcalc.png)
- перевод маски /15 в обычную и двоичную запись\
![Вывод команды ipcalc](img/1_1_3_ipcalc.png)
- перевод маски 11111111.11111111.11111111.11110000 в обычную и префиксную запись\
![Вывод команды ipcalc](img/1_1_4_ipcalc.png)
- минимальный и максимальный хост в сети 12.167.38.4 при маске /8\
![Вывод команды ipcalc](img/1_1_5_ipcalc.png)
- минимальный и максимальный хост в сети 12.167.38.4 при маске 11111111.11111111.00000000.00000000\
![Вывод команды ipcalc](img/1_1_6_ipcalc.png)
- минимальный и максимальный хост в сети 12.167.38.4 при маске 255.255.254.0\
![Вывод команды ipcalc](img/1_1_7_ipcalc.png)
- минимальный и максимальный хост в сети 12.167.38.4 при маске /4\
![Вывод команды ipcalc](img/1_1_8_ipcalc.png)

### 1.2. localhost
- Из вывода команды **`ping`** видно, что можно обратиться к **`localhost`** со следующими адресами:

| Адрес         | Можно обратиться |
| ------------- | ---------------- |
| 194.34.23.100 | -                |
| 127.0.0.2     | +                |
| 127.1.0.1     | +                |
| 128.0.0.1     | -                |

![Вывод команды ping](img/1_2_1_localhost.png)

Также loopback-адреса отмечаются соответствующим тегом в выводе ipcalc\
![Вывод команды ipcalc](img/1_2_2_localhost.png)

### 1.3. Диапазоны и сегменты сетей
-  Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 

| Адрес          | Частный |
|----------------|---------|
| 10.0.0.45      |    +    |
| 134.43.0.2     |    -    |
| 192.168.4.2    |    +    |
| 172.20.250.4   |    +    |
| 172.0.2.1      |    -    |
| 192.172.0.1    |    -    |
| 172.68.0.2     |    -    |
| 172.16.255.255 |    +    |
| 10.10.10.10    |    +    |
| 192.169.168.1  |    -    |

Класс А: 10.0.0.0 – 10.255.255.255\
Класс Б: 172.16.0.0 – 172.31.255.255\
Класс С: 192.168.0.0 – 192.168.255.255

В выводе ipcalc приватные адреса помечаются тегом **`Private Internet`**\
![Вывод команды ipcalc](img/1_3_1_private_host.png)

- какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18:

| Адрес       | Может быть шлюзом |
|-------------|-------------------|
| 10.0.0.1    |         -         |
| 10.10.0.2   |         +         |
| 10.10.10.10 |         +         |
| 10.10.100.1 |         -         |
| 10.10.1.255 |         +         |

Диапозон допустимых адесов для сети отображается в выводе **`ipcalc`**\
![Вывод команды ipcalc](img/1_3_2_router_IP.png)

## Part 2. Статическая маршрутизация между двумя машинами

- С помощью команды **`ip a`** посмотреть существующие сетевые интерфейсы\
![Вывод команды ip a](img/2_0_1_ip_a.png)\
![Вывод команды ip a](img/2_0_2_ip_a.png)
- Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12\
![Вывод netplan](img/2_0_3_yaml.png)\
![Вывод netplan](img/2_0_4_yaml.png)
- Выполнить команду **`netplan apply`** для перезапуска сервиса сети\
![Вывод команды ping](img/2_0_5_netplan.png)\
![Вывод команды ping](img/2_0_6_netplan.png)

### 2.1. Добавление статического маршрута вручную

- Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида **`ip r add`**\
![Вывод команды ip r add](img/2_1_1_ip_r_add.png)\
![Вывод команды ip r add](img/2_1_2_ip_r_add.png)
- Пропинговать соединение между машинами\
![Вывод команды ping](img/2_1_3_ping.png)\
![Вывод команды ping](img/2_1_4_ping.png)

### 2.2. Добавление статического маршрута с сохранением

- Добавить статический маршрут от одной машины до другой с помощью файла **`etc/netplan/00-installer-config.yaml`**\
![Вывод netplan](img/2_2_1_netplan.png)\
![Вывод netplan](img/2_2_2_netplan.png)
- Пропинговать соединение между машинами\
![Вывод команды ping](img/2_2_3_ping.png)\
![Вывод команды ping](img/2_2_4_ping.png)

## Part 3. Утилита iperf3

### 3.1. Скорость соединения

- Перевести и записать в отчёт:\
8 Mbps в MB/s: 1 MB/s\
100 MB/s в Kbps: 819200 Kbps\
1 Gbps в Mbps: 1024 Mbps\

### 3.2. Утилита iperf3

- Измерить скорость соединения между ws1 и ws2\
На сервере выполняем команду **`iperf3 -s`**\
![Вывод команды ioerf3](img/3_2_1_iperf3.png)\
С клиента подключаемся к серверу командой **`iperf3 -c 192.168.100.10`**\
![Вывод команды ioerf3](img/3_2_2_iperf3.png)

## Part 4. Сетевой экран

### 4.1. Утилита iptables

Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2:

Нужно добавить в файл подряд следующие правила:

- на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)

- на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)

- открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)

- запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)

- разрешить echo reply (машина должна "пинговаться")

- Скрин с содержанием файла **`/etc/firewall.sh`** на **`ws1`**\
![Вывод команды ping](img/4_1_1_firewall_sh.png)
- Скрин с содержанием файла **`/etc/firewall.sh`** на **`ws2`**\
![Вывод команды ping](img/4_1_2_firewall_sh.png)

- Запустить файлы на **`ws1`** командами **`chmod +x /etc/firewall.sh`** и **`/etc/firewall.sh`**, выводим **`iptables`** и пингуем **`ws2`**\
![Вывод команды ping](img/4_1_3_iptables.png)\
- Запустить файлы на **`ws2`** командами **`chmod +x /etc/firewall.sh`** и **`/etc/firewall.sh`**, выводим **`iptables`** и пингуем **`ws1`**\
![Вывод команды ping](img/4_1_4_iptables.png)

Разница между примененными стратегиями заключается в том, что, как видно из скринов, **`ws1`** не отвечает на пинг. Таким образом, можно сделать вывод, что применяется первое подходящее правило, а все последующие игнорируются.

### 4.2. Утилита nmap

- Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен
- Проверка: в выводе nmap сказано: Host is up\
![Вывод команды ping](img/4_2_1_nmap.png)

## Part 5. Статическая маршрутизация сети

Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2)) согласно схеме:
![Схема](img/5_1_1_network_map.png)

### 5.1. Настройка адресов машин

Файл **`etc/netplan/00-installer-config.yaml`** на **`r1`**\
![Файл 00-installer-config.yaml](img/5_1_2_r1_yaml.png)\
Файл **`etc/netplan/00-installer-config.yaml`** на **`r2`**\
![Файл 00-installer-config.yaml](img/5_1_3_r2_yaml.png)\
Файл **`etc/netplan/00-installer-config.yaml`** на **`ws11`**\
![Файл 00-installer-config.yaml](img/5_1_4_ws11_yaml.png)\
Файл **`etc/netplan/00-installer-config.yaml`** на **`ws21`**\
![Файл 00-installer-config.yaml](img/5_1_5_ws21_yaml.png)\
Файл **`etc/netplan/00-installer-config.yaml`** на **`ws22`**\
![Файл 00-installer-config.yaml](img/5_1_6_ws22_yaml.png)\
Командой **`ip -4 a`** проверяем, что адрес машины задан верно на **`r1`**\
![Вывод ip](img/5_1_7_r1_ip.png)\
Командой **`ip -4 a`** проверяем, что адрес машины задан верно на **`r2`**\
![Вывод ip](img/5_1_8_r2_ip.png)\
Командой **`ip -4 a`** проверяем, что адрес машины задан верно на **`ws11`**, а также пингуем **`r1`**\
![Вывод ip](img/5_1_9_ws11_ip.png)\
Командой **`ip -4 a`** проверяем, что адрес машины задан верно на **`ws21`**, а также пингуем **`ws22`**\
![Вывод ip](img/5_1_10_ws21_ip.png)\
Командой **`ip -4 a`** проверяем, что адрес машины задан верно на **`ws22`**\
![Вывод ip](img/5_1_11_ws22_ip.png)

### 5.2. Включение переадресации IP-адресов.

- Для включения переадресации IP, выполняем команду на роутерах: **`sysctl -w net.ipv4.ip_forward=1`**. При таком подходе переадресация не будет работать после перезагрузки системы.\
На роутере **`r1`**\
![Вывод ip_forward](img/5_2_1_ip_forward.png)\
На роутере **`r2`**\
![Вывод ip_forward](img/5_2_2_ip_forward.png)

- Откройте файл /etc/sysctl.conf и добавьте в него следующую строку: **`net.ipv4.ip_forward = 1`**. При использовании этого подхода, IP-переадресация включена на постоянной основе.\
На роутере **`r1`**\
![Вывод ip_forward](img/5_2_3_ip_forward.png)\
На роутере **`r2`**\
![Вывод ip_forward](img/5_2_4_ip_forward.png)

### 5.3. Установка маршрута по-умолчанию

- Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить default перед IP роутера в файле конфигураций.\
Файл **`netplan/00-installer-config.yaml`** на **`ws11`**\
![Файл netplan/00-installer-config.yaml](img/5_3_1_netplan.png)\
Файл **`netplan/00-installer-config.yaml`** на **`ws21`**\
![Файл netplan/00-installer-config.yaml](img/5_3_2_netplan.png)\
Файл **`netplan/00-installer-config.yaml`** на **`ws22`**\
![Файл netplan/00-installer-config.yaml](img/5_3_3_netplan.png)

- Вызвать **`ip r`** и показать, что добавился маршрут в таблицу маршрутизации.\
Вывод **`ip r`** на **`ws11`**\
![Вывод ip r](img/5_3_4_ip_r.png)\
Вывод **`ip r`** на **`ws21`**\
![Вывод ip r](img/5_3_5_ip_r.png)\
Вывод **`ip r`** на **`ws22`**\
![Вывод ip r](img/5_3_6_ip_r.png)

- Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду: **`tcpdump -tn -i eth0`**.\
Вывод **`ping 10.100.0.12`** на **`ws11`**\
![Вывод ping](img/5_3_7_ping.png)\
Вывод **`tcpdump -tn -i eth0`** на **`r2`**\
![Вывод ping](img/5_3_8_tcpdump.png)

### 5.4. Добавление статических маршрутов

- Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.\
Файл **`netplan/00-installer-config.yaml`** на **`r1`**\
![Файл netplan/00-installer-config.yaml](img/5_4_1_netplan.png)\
Файл **`netplan/00-installer-config.yaml`** на **`r2`**\
![Файл netplan/00-installer-config.yaml](img/5_4_2_netplan.png)
- Вызвать ip r и показать таблицы с маршрутами на обоих роутерах.\
Вывод **`ip r`** на **`r1`**\
![Вывод ip r](img/5_4_3_ip_r.png)\
Вывод **`ip r`** на **`r2`**\
![Вывод ip r](img/5_4_4_ip_r.png)
- Запустить команды на ws11: ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0\
![Вывод ip r](img/5_4_5_ip_r.png)

В случае если подходит несколько маршрутов, выбирается маршрут с самой длинной маской.

### 5.5. Построение списка маршрутизаторов

- Запустить на **`r1`** команду дампа: **`tcpdump -tnv -i eth0`**\
![Вывод tcpdump](img/5_5_2_traceroute.png)

- При помощи утилиты **`traceroute`** построить список маршрутизаторов на пути от **`ws11`** до **`ws21`**\
![Вывод traceroute](img/5_5_1_traceroute.png)

Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. Причем, каждый пакет имеет свое время жизни. Это количество узлов, которые может пройти пакет перед тем, как он будет уничтожен. Этот параметр записывается в заголовке TTL, каждый маршрутизатор, через который будет проходить пакет уменьшает его на единицу. При TTL=0 пакет уничтожается, а отправителю отсылается сообщение Time Exceeded.

Команда traceroute linux использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной.

### 5.6. Использование протокола ICMP при маршрутизации

- Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды: **`tcpdump -n -i eth0 icmp`**\
![Вывод tcpdump](img/5_6_1_tcpdump.png)
- Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды: **`ping -c 1 10.30.0.111`**\
![Вывод ping](img/5_6_2_ping.png)

## Part 6. Динамическая настройка IP с помощью DHCP

Для **`r2`** настроить в файле **`/etc/dhcp/dhcpd.conf`** конфигурацию службы DHCP:
- Устанавливаем DHCP-сервер командой **`sudo apt install isc-dhcp-server`**.
- указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети:\
![Файл dhcpd](img/6_1_dhcpd.png)

- в файле **`resolv.conf`** прописать nameserver 8.8.8.8.\
![Файл resolv](img/6_2_resolv.png)

- Перезагрузить службу **`DHCP`** командой **`systemctl restart isc-dhcp-server`**. Машину **`ws21`** перезагрузить при помощи **`reboot`** и через **`ip a`** показать, что она получила адрес. Также пропинговать **`ws22`** с **`ws21`**.\
Перезапускаем слжбу **`DHCP`**\
![Команда restart](img/6_3_restart.png)\
Редактируем настроки\
![Файл netplan](img/6_4_netplan.png)\
Проверяем с помощью **`ip a`**\
![Вывод ip a](img/6_5_ip_a.png)\
Пингуем **`ws22`**\
![Вывод ping](img/6_6_ping.png)

- Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true\
![Файл netplan](img/6_7_netplan.png)

- Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты.\
Редактируем файл **`resolv.conf`**\
![Файл netplan](img/6_8_dhcpd.png)\
Проверяем с помощью **`ip a`**\
![Вывод ip a](img/6_9_ip_a.png)\
Пингуем **`ws21`**\
![Вывод ping](img/6_10_ping.png)

- Запросить с **ws22** обновление ip адреса.\
Обновляем ip адрес командой **`sudo dhclient -r; sudo dhclient`**, затем проверяем изменение командой **`ip a`**
![Вывод ip a](img/6_11_dhclient.png)

## Part 7. NAT

- В файле **`/etc/apache2/ports.conf`** на **`ws22`** и **`r1`** изменить строку **`Listen 80`** на **`Listen 0.0.0.0:80`**, то есть сделать сервер **`Apache2`** общедоступным.\
Файл **`ports.conf`** на **`ws22`**\
![Файл ports.conf](img/7_1_ports_conf.png)\
Файл **`ports.conf`** на **`r1`**\
![Файл ports.conf](img/7_2_ports_conf.png)

- Запустить веб-сервер Apache командой **`service apache2 start`** на **`ws22`** и **`r1`**.\
Запуск **`Apache2`** на **`ws22`**\
![Вывод apache2 status](img/7_3_apache_start.png)\
Запуск **`Apache2`** на **`r1`**\
![Вывод apache2 status](img/7_4_apache_start.png)

Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на **`r2`** следующие правила:
- удаление правил в таблице filter - **`iptables -F`**
- удаление правил в таблице "NAT" - **`iptables -F -t nat`**
- отбрасывать все маршрутизируемые пакеты - **`iptables --policy FORWARD DROP`**\
![Скрипт настройки iptables](img/7_5_iptables.png)
- Запускать файл также, как в Части 4\
![Вывод ping](img/7_8_firewall_nat.png)
- Проверить соединение между **`ws22`** и **`r1`** командой **`ping`**
- При запуске файла с этими правилами, **`ws22`** не должна "пинговаться" с **`r1`**\
![Вывод ping](img/7_6_ping.png)

Добавить в файл ещё одно правило:
- разрешить маршрутизацию всех пакетов протокола **`ICMP`**\
![Скрипт настройки iptables](img/7_7_iptables.png)
- Запускать файл также, как в Части 4\
![Скрипт настройки iptables](img/7_8_firewall_nat.png)
- Проверить соединение между **`ws22`** и **`r1`** командой **`ping`**
- При запуске файла с этими правилами, **`ws22`** должна "пинговаться" с **`r1`**\
![Вывод ping](img/7_9_ping.png)

Добавить в файл ещё два правила:

- включить **`SNAT`**, а именно маскирование всех локальных ip из локальной сети, находящейся за **`r2`** (по обозначениям из Части 5 - сеть 10.20.0.0. Совет: стоит подумать о маршрутизации внутренних пакетов, а также внешних пакетов с установленным соединением
- включить **`DNAT`** на **`8080`** порт машины **`r2`** и добавить к веб-серверу **`Apache`**, запущенному на **`ws22`**, доступ извне сети. Совет: стоит учесть, что при попытке подключения возникнет новое tcp-соединение, предназначенное **`ws22`** и **`80`** порту\
![Скрипт настройки iptables](img/7_10_iptables.png)

- Запускать файл также, как в Части 4. Перед тестированием рекомендуется отключить сетевой интерфейс NAT (его наличие можно проверить командой ip a) в VirtualBox, если он включен

- Проверить соединение по TCP для SNAT, для этого с **`ws22`** подключиться к серверу Apache на **`r1`** командой: **`telnet 10.100.0.11 80`**\
![Вывод telnet](img/7_11_telnet.png)

- Проверить соединение по TCP для DNAT, для этого с **`r1`** подключиться к серверу Apache на **`ws22`** командой **`telnet`** (обращаться по адресу **`r2`** и порту **`8080`**)\
![Вывод telnet](img/7_12_telnet.png)

## Part 8. Дополнительно. Знакомство с SSH Tunnels

- Запустить на **`r2`** фаервол с правилами из Части 7\
![Скрипт настройки iptables](img/7_13_iptables.png)\
![Вывод iptable --list](img/7_14_iptables.png)

- Запустить веб-сервер **`Apache`** на **`ws22`** только на **`localhost`** (то есть в файле **`/etc/apache2/ports.conf`** изменить строку **`Listen 80`** на **`Listen localhost:80`**)\
![Файл ports.conf](img/7_15_ports_conf.png)

- Воспользоваться **`Local TCP forwarding`** с **`ws21`** до **`ws22`**, чтобы получить доступ к веб-серверу на **`ws22`** с **`ws21`**\
![Local TCP forwarding](img/7_16_ssh_tunnel.png)

- Воспользоваться **`Remote TCP forwarding`** c **`ws11`** до **`ws22`**, чтобы получить доступ к веб-серверу на **`ws22`** с **`ws11`**\
![Remote TCP forwarding](img/7_18_ssh_tunnel.png)

- Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами **`Alt + F2`**) и выполните команду: **`telnet 127.0.0.1 [локальный порт]`**\
Проверяем подключение на **`ws21`**\
![Вывод telnet](img/7_17_telnet.png)\
Проверяем подключение на **`ws11`**\
![Вывод telnet](img/7_19_telnet.png)
